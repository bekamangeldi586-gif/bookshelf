{% extends 'library/base.html' %}
{% load static %}
{% block content %}
  <h1>
    {% if lang == 'ru' %}Статистика использования{% elif lang == 'en' %}Usage Statistics{% elif lang == 'kz' %}Қолдану статистикасы{% else %}Usage Statistics{% endif %}
  </h1>
  <p>
    {% if lang == 'ru' %}
      Данные берутся из <a href="{% url 'itemuse_json' %}" target="_blank"><code>/stat/itemuse</code></a> и отображаются столбчатой диаграммой.
    {% elif lang == 'en' %}
      Data is taken from <a href="{% url 'itemuse_json' %}" target="_blank"><code>/stat/itemuse</code></a> and displayed as a bar chart.
    {% elif lang == 'kz' %}
      Деректер <a href="{% url 'itemuse_json' %}" target="_blank"><code>/stat/itemuse</code></a> жерінен алынып, бағаналы диаграмма ретінде көрсетіледі.
    {% else %}
      Data is taken from <a href="{% url 'itemuse_json' %}" target="_blank"><code>/stat/itemuse</code></a> and displayed as a bar chart.
    {% endif %}
  </p>
  <div class="chart-container" style="width: 100%; max-width: 1000px; margin: 40px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <canvas id="usageChart" style="width: 100%; height: 400px; display: block;"></canvas>
    <div style="height:30px"></div>
    <canvas id="usagePie" style="width: 100%; height: 360px; display: block;"></canvas>
  </div>

  <script src="{% static 'library/js/simplechart.js' %}"></script>
  <script>
    async function fetchData() {
      const res = await fetch('{% url "itemuse_json" %}');
      if (!res.ok) throw new Error('Failed to load data');
      return res.json();
    }

    function prepareDataset(json) {
      const labels = [];
      const data = [];
      if (!json || !Array.isArray(json.items)) return {labels, data};
      json.items.forEach(it => {
        labels.push(it.date);
        data.push(it.value);
      });
      return {labels, data};
    }

    (async function() {
      try {
        const json = await fetchData();
        const ds = prepareDataset(json);
        const lang = '{{ lang }}';

        const strings = {
          'ru': {
            title: 'Количество человек, взявших книги',
            yLabel: 'Человек',
            xLabel: 'Месяц'
          },
          'en': {
            title: 'People who took books',
            yLabel: 'People',
            xLabel: 'Month'
          },
          'kz': {
            title: 'Кітап алған адамдар',
            yLabel: 'Адамдар',
            xLabel: 'Ай'
          }
        };
        const str = strings[lang] || strings['en'];

        const chart = new SimpleBarChart('usageChart', {
          barColor: '#3682eb',
          textColor: '#333'
        });
        chart.draw(ds.data, ds.labels, str.title, str.yLabel, str.xLabel);

        // Also draw pie chart with same data (distribution)
        try {
          const pie = new SimplePieChart('usagePie', { textColor: '#333' });
          // For pie labels, we can show month names; if labels are like '01.2025' keep as-is
          pie.draw(ds.data, ds.labels, (lang === 'ru') ? 'Доля по месяцам' : (lang === 'kz') ? 'Айлар бойынша үлес' : 'Share by Month');
        } catch (e) {
          console.warn('Pie chart not available', e);
        }

      } catch (err) {
        console.error(err);
        var errMsg = (lang === 'ru') ? 'Ошибка загрузки данных.' : (lang === 'kz') ? 'Деректерді жүктеу қатесі.' : 'Failed to load data.';
        document.body.insertAdjacentHTML('beforeend', '<p style="color:red">' + errMsg + '</p>');
      }
    })();
  </script>
{% endblock %}
